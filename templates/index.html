<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Application</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="/static/css/chat.css">
</head>
<body>
    <div class="wrapper-title">
        <h1>Turbo epic chat room ðŸ˜Ž</h1>
        <div class="logout-link">
            <p>Welcome, {{ username }}! <a href="{{ url_for('logout') }}">Logout</a></p>
        </div>

        <div class="theme-selector">
            <label for="theme"> Choose a theme: </label>
            <select id="theme" onchange="changeTheme()">
                <option value="blue">Blue</option>
                <option value="dark">Dark</option>
                <option value="purple">Purple</option>
            </select>
        </div>
    </div>

    <div class="chat-container">
        <div class="wrapper">
            <div id="messages"></div>
            <div class="input-container">
                <input type="text" id="message-input" placeholder="Enter your message">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>

        <div class="wrapper">
            <h1>Online users</h1>
            <div id="online-users"></div>
        </div>
    </div>

    <script>
        const socket = io();
        let aesKey;
        const currentUser = '{{ username }}';
    
        socket.on('connect', function() {
            socket.emit('join');
            importAESKey().then(() => {
                console.log("AES Key imported, ready to decrypt messages");
            });
        });
    
        socket.on('message', function(data) {
            console.log("Received encrypted message:", data.msg);
            decryptAES(data.msg).then(decryptedMessage => {
                console.log("Decrypted message:", decryptedMessage);
                if (data.username !== currentUser) {
                    $('#messages').append(`<div class="message received"><strong>${data.username}</strong>: ${decryptedMessage}</div>`);
                    $('#messages').scrollTop($('#messages')[0].scrollHeight);
                }
            }).catch(error => {
                console.error('Decryption error:', error);
            });
        });
        /*
        socket.on('activeUsers', function(users) {
            $('#online-users').empty();
            users.forEach(user => {
                $('#online-users').append(`<p>${user}</p>`);
            });
        });
        */

        socket.on('activeUsers', function(users) {
            const userList = users.join(', ');
            $('#online-users').text(userList);
        });
    
        function sendMessage() {
            const message = $('#message-input').val();
            if (message.trim() !== "") {
                console.log("Sending message:", message);
                $('#messages').append(`<div class="message sent"><strong>You</strong>: ${message}</div>`);
                $('#messages').scrollTop($('#messages')[0].scrollHeight);
                socket.emit('message', {msg: message, username: currentUser});
                $('#message-input').val('');
            }
        }
    
        async function importAESKey() {
            const keyMaterial = new TextEncoder().encode('secret_aes_key');
            return crypto.subtle.digest('SHA-256', keyMaterial).then(hash => {
                return crypto.subtle.importKey(
                    'raw',
                    hash,
                    { name: 'AES-CBC' },
                    false,
                    ['encrypt', 'decrypt']
                ).then(key => {
                    aesKey = key;
                    console.log("AES key imported successfully");
                });
            });
        }
    
        async function decryptAES(encryptedHex) {
            if (!aesKey) {
                await importAESKey();
            }
    
            const encryptedBytes = hexToBytes(encryptedHex);
            const iv = encryptedBytes.slice(0, 16);
            const ct = encryptedBytes.slice(16);
    
            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-CBC', iv: iv },
                aesKey,
                ct
            );
    
            return new TextDecoder().decode(decrypted);
        }
    
        function hexToBytes(hex) {
            const bytes = [];
            for (let c = 0; c < hex.length; c += 2) {
                bytes.push(parseInt(hex.substr(c, 2), 16));
            }
            return new Uint8Array(bytes);
        }


        function changeTheme() {
            const theme = document.getElementById('theme').value;
            document.body.className = '';
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            }
            else if (theme === 'purple') {
                document.body.classList.add('purple-theme');
            }
            else
            {
                document.body.classList.add('blue-theme');
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            document.body.classList.add('blue-theme');
        });

    </script>    
</body>
</html>
